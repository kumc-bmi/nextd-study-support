---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
-----                             Part 2: Encounters for the study sample                                 -----  
--------------------------------------------------------------------------------------------------------------- 
/* Tables for this eaxtraction: 
1. Table 1 (named here [NextD].[dbo].[FinalStatTable1]) with Next-D study sample IDs. See separate SQL code for producing this table.
2. ENCOUNTER table from CAPRICORN.
3. External source table (#RawInsuranceValuesTable) with insurance values on encounters of interest.
4. External source table (#RawNPIvaluesTable) with NPI values on encounters of interest.
5. Tabel with mapping (named here #GlobalIDtable) between PCORNET IDs and Global patient IDs provided by MRAIA. */
--------------------------------------------------------------------------------------------------------------- 
-----  Declare study time frame variables:
DECLARE @studyTimeRestriction int;declare @UpperTimeFrame DATE; declare @LowerTimeFrame DATE;
-----                             Specify time frame and age limits                                       -----
--Set extraction time frame below. If time frames not set, the code will use the whole time frame available from the database
set @LowerTimeFrame='2011-01-01';
set @UpperTimeFrame=getdate();/* insert here thw end exctraction date from iRB*/
--set age restrictions:
declare @UpperAge int; declare @LowerAge int;set @UpperAge=89; set @LowerAge=18;
---------------------------------------------------------------------------------------------------------------
/* Steps for insurance remap:

1. Load provided by NU team remapping table named MasterReMap. It has following columns:
[RAW_financial_class_dsc],[RAW_cdf_meaning],[RAW_BENEFIT_PLAN_NAME],[RAW_PRODUCT_TYPE],[RAW_PAYOR_NAME],[RAW_EPM_ALT_IDFR],[RAW_SHORT_NAME],[NewCategory]
2. Load table (named here #RawNPIValuesTable) with coresponding NPI values for each encounter of interest.
3. Remap raw values into new insurance and provider categories :*/
---------------------------------------------------------------------------------------------------------------
select a1.[PATID],a.[ENCOUNTERID],a.[INSURANCE],c.[financial_class_dsc],c.[cdf_meaning],c.[BENEFIT_PLAN_NAME],c.[PRODUCT_TYPE],c.[PAYOR_NAME],c.[EPM_ALT_IDFR],c.[SHORT_NAME],b.NewCategory as PrimaryInsuranceType,d.NPI
into #NEXTD_ENCOUNTERSRemap
from /* provide name of table 1 here: */ [NextD].[dbo].[FinalStatTable1] a1 join [capricorn].[dbo].[CAP_ENCOUNTERS] as a on a1.[PATID]=a.[CAP_ID]
left join /* provide name of table with values [RAW_financial_class_dsc],[RAW_cdf_meaning],[RAW_BENEFIT_PLAN_NAME],[RAW_PRODUCT_TYPE],[RAW_PAYOR_NAME],[RAW_EPM_ALT_IDFR],[RAW_SHORT_NAME],[NewCategory] 
for encounters listed in [capricorn].[dbo].[ENCOUNTER] */
#RawInsuranceValuesTable c on /* Must figure out right for your system linkage here: */ a.[ENCOUNTERID]=c.[ENCOUNTERID] 
left join [NextD].[dbo].[MasterReMap] as b on isnull(c.BENEFIT_PLAN_NAME,'')=isnull(b.RAW_BENEFIT_PLAN_NAME,'') 
											and isnull(c.PRODUCT_TYPE,'')=isnull(b.RAW_PRODUCT_TYPE,'') 
											and isnull(c.PAYOR_NAME,'')=isnull(b.RAW_PAYOR_NAME,'') 
											and isnull(c.EPM_ALT_IDFR,'')=isnull(b.RAW_EPM_ALT_IDFR,'') 
											and isnull(c.SHORT_NAME,'')=isnull(b.RAW_SHORT_NAME,'') 
											and isnull(c.financial_class_dsc,'')=isnull(b.RAW_financial_class_dsc,'') 
											and isnull(c.cdf_meaning,'')=isnull(b.RAW_cdf_meaning,'')
left join /* provide here table with NPI values of providers mainly responsible for the encounter; table columns might be following: [PATID],[ENCOUNTERID],[NPI]*/ 
#RawNPIvaluesTable d on a.[ENCOUNTERID]=d.[ENCOUNTERID];
--------------------------------------------------------------------------------------------------------------- 
select i.PATID,i.ENCOUNTERID,i.PROVIDERID, i.ADMIT_DATE,i.ENC_TYPE,i.FACILITYID,i.IndividualProviderCategories,i.PrimaryInsuranceType  
into #NextD_ENCOUNTER
from (select c.PATID,a.ENCOUNTERID,a.PROVIDERID,a.ADMIT_DATE,a.ENC_TYPE,a.FACILITYID,
			case when b.NPI is not NULL and b.NPI in ('102X00000X','171R00000X','172A00000X','247ZC0005X','367A00000X','374K00000X','374T00000X','376G00000X','390200000X') then '0'
			when b.NPI is not NULL and b.NPI in ('202C00000X','202K00000X','204C00000X','204D00000X','204E00000X','204F00000X','204R00000X','207K00000X','207KA0200X','207KI0005X','207L00000X','207LA0401X','207LC0200X',
						'207LH0002X','207LP2900X','207LP3000X','207N00000X','207ND0101X','207ND0900X','207NI0002X','207NP0225X','207NS0135X','207P00000X','207PE0004X','207PE0005X','207PH0002X','207PP0204X',
						'207PS0010X','207PT0002X','207Q00000X','207QA0000X','207QA0401X','207QA0505X','207QB0002X','207QG0300X','207QH0002X','207QS0010X','207QS1201X','207R00000X','207RA0000X','207RA0001X',
						'207RA0201X','207RA0401X','207RB0002X','207RC0000X','207RC0001X','207RC0200X','207RE0101X','207RG0100X','207RG0300X','207RH0000X','207RH0002X','207RH0003X','207RH0005X','207RI0001X',
						'207RI0008X','207RI0011X','207RI0200X','207RM1200X','207RN0300X','207RP1001X','207RR0500X','207RS0010X','207RS0012X','207RT0003X','207RX0202X','207SC0300X','207SG0201X','207SG0202X',
						'207SG0203X','207SG0205X','207SM0001X','207T00000X','207U00000X','207UN0901X','207UN0902X','207UN0903X','207V00000X','207VB0002X','207VC0200X','207VE0102X','207VF0040X','207VG0400X',
						'207VH0002X','207VM0101X','207VX0000X','207VX0201X','207W00000X','207WX0009X','207WX0107X','207WX0108X','207WX0200X','207X00000X','207XP3100X','207XS0106X','207XS0114X','207XS0117X',
						'207XX0004X','207XX0005X','207XX0801X','207Y00000X','207YP0228X','207YS0012X','207YS0123X','207YX0007X','207YX0602X','207YX0901X','207YX0905X','207ZB0001X','207ZC0006X','207ZC0008X',
						'207ZC0500X','207ZD0900X','207ZF0201X','207ZH0000X','207ZI0100X','207ZM0300X','207ZN0500X','207ZP0007X','207ZP0101X','207ZP0102X','207ZP0104X','207ZP0105X','208100000X','2081H0002X',
						'2081N0008X','2081P0004X','2081P0010X','2081P0301X','2081P2900X','2081S0010X','208200000X','2082S0099X','2082S0105X','2083A0100X','2083B0002X','2083C0008X','2083P0011X','2083P0500X',
						'2083P0901X','2083S0010X','2083T0002X','2083X0100X','2084A0401X','2084A2900X','2084B0002X','2084B0040X','2084D0003X','2084F0202X','2084H0002X','2084N0008X','2084N0400X','2084N0402X',
						'2084N0600X','2084P0005X','2084P0015X','2084P0301X','2084P0800X','2084P0802X','2084P0804X','2084P0805X','2084P2900X','2084S0010X','2084S0012X','2084V0102X','2085B0100X','2085D0003X',
						'2085H0002X','2085N0700X','2085N0904X','2085P0229X','2085R0001X','2085R0202X','2085R0203X','2085R0204X','2085R0205X','2085U0001X','208600000X','2086H0002X','2086S0102X','2086S0105X',
						'2086S0120X','2086S0122X','2086S0127X','2086S0129X','2086X0206X','208800000X','2088F0040X','2088P0231X','208C00000X','208D00000X','208G00000X','208M00000X','208U00000X','208VP0000X',
						'208VP0014X','209800000X','363A00000X','363AM0700X','363AS0400X') then 'Physician'
			when b.NPI is not NULL and b.NPI in ('163W00000X','163WA0400X','163WA2000X','163WC0200X','163WC0400X','163WC1400X','163WC1500X','163WC1600X','163WC2100X','163WC3500X','163WD0400X','163WD1100X','163WE0003X',
						'163WE0900X','163WF0300X','163WG0000X','163WG0100X','163WG0600X','163WH0200X','163WH0500X','163WH1000X','163WI0500X','163WI0600X','163WL0100X','163WM0102X','163WM0705X','163WM1400X',
						'163WN0002X','163WN0003X','163WN0300X','163WN0800X','163WN1003X','163WP0000X','163WP0200X','163WP0218X','163WP0807X','163WP0808X','163WP0809X','163WP1700X','163WP2201X','163WR0006X',
						'163WR0400X','163WR1000X','163WS0121X','163WS0200X','163WU0100X','163WW0000X','163WW0101X','163WX0002X','163WX0003X','163WX0106X','163WX0200X','163WX0601X','163WX0800X','163WX1100X',
						'163WX1500X','164W00000X','164X00000X','363L00000X','363LA2100X','363LA2200X','363LC0200X','363LC1500X','363LF0000X','363LG0600X','363LN0000X','363LN0005X','363LP0200X','363LP0222X',
						'363LP0808X','363LP1700X','363LP2300X','363LS0200X','363LW0102X','363LX0001X','363LX0106X','364S00000X','364SA2100X','364SA2200X','364SC0200X','364SC1501X','364SC2300X','364SE0003X',
						'364SE1400X','364SF0001X','364SG0600X','364SH0200X','364SH1100X','364SI0800X','364SL0600X','364SM0705X','364SN0000X','364SN0800X','364SP0200X','364SP0807X','364SP0808X','364SP0809X',
						'364SP0810X','364SP0811X','364SP0812X','364SP0813X','364SP1700X','364SP2800X','364SR0400X','364SS0200X','364ST0500X','364SW0102X','364SX0106X','364SX0200X','364SX0204X','367500000X') then 'APP'
			when b.NPI is not NULL and b.NPI in ('101Y00000X','101YA0400X','101YM0800X','101YP1600X','101YP2500X','101YS0200X','102L00000X','103G00000X','103GC0700X','103K00000X','103T00000X','103TA0400X','103TA0700X',
						'103TB0200X','103TC0700X','103TC1900X','103TC2200X','103TE1000X','103TE1100X','103TF0000X','103TF0200X','103TH0004X','103TH0100X','103TM1700X','103TM1800X','103TP0016X','103TP0814X',
						'103TP2700X','103TP2701X','103TR0400X','103TS0200X','103TW0100X','104100000X','1041C0700X','1041S0200X','106E00000X','106H00000X','106S00000X','111N00000X','111NI0013X','111NI0900X',
						'111NN0400X','111NN1001X','111NP0017X','111NR0200X','111NR0400X','111NS0005X','111NT0100X','111NX0100X','111NX0800X','122300000X','1223D0001X','1223D0004X','1223E0200X','1223G0001X',
						'1223P0106X','1223P0221X','1223P0300X','1223P0700X','1223S0112X','1223X0008X','1223X0400X','122400000X','124Q00000X','125J00000X','125K00000X','125Q00000X','126800000X','126900000X',
						'132700000X','133N00000X','133NN1002X','133V00000X','133VN1004X','133VN1005X','133VN1006X','136A00000X','146D00000X','146L00000X','146M00000X','146N00000X','152W00000X','152WC0802X',
						'152WL0500X','152WP0200X','152WS0006X','152WV0400X','152WX0102X','156F00000X','156FC0800X','156FC0801X','156FX1100X','156FX1101X','156FX1201X','156FX1202X','156FX1700X','156FX1800X',
						'156FX1900X','167G00000X','170100000X','170300000X','171000000X','1710I1002X','1710I1003X','171100000X','171M00000X','171W00000X','171WH0202X','171WV0202X','172M00000X','172P00000X',
						'172V00000X','173000000X','173C00000X','173F00000X','174400000X','1744G0900X','1744P3200X','1744R1102X','1744R1103X','174H00000X','174N00000X','174V00000X','175F00000X','175L00000X',
						'175M00000X','175T00000X','176B00000X','176P00000X','183500000X','1835C0205X','1835G0000X','1835G0303X','1835N0905X','1835N1003X','1835P0018X','1835P0200X','1835P1200X','1835P1300X',
						'1835P2201X','1835X0200X','183700000X','193200000X','193400000X','211D00000X','213E00000X','213EG0000X','213EP0504X','213EP1101X','213ER0200X','213ES0000X','213ES0103X','213ES0131X',
						'221700000X','222Q00000X','222Z00000X','224900000X','224L00000X','224P00000X','224Y00000X','224Z00000X','224ZE0001X','224ZF0002X','224ZL0004X','224ZR0403X','225000000X','225100000X',
						'2251C2600X','2251E1200X','2251E1300X','2251G0304X','2251H1200X','2251H1300X','2251N0400X','2251P0200X','2251S0007X','2251X0800X','225200000X','225400000X','225500000X','2255A2300X',
						'2255R0406X','225600000X','225700000X','225800000X','225A00000X','225B00000X','225C00000X','225CA2400X','225CA2500X','225CX0006X','225X00000X','225XE0001X','225XE1200X','225XF0002X',
						'225XG0600X','225XH1200X','225XH1300X','225XL0004X','225XM0800X','225XN1300X','225XP0019X','225XP0200X','225XR0403X','226000000X','226300000X','227800000X','2278C0205X','2278E0002X',
						'2278E1000X','2278G0305X','2278G1100X','2278H0200X','2278P1004X','2278P1005X','2278P1006X','2278P3800X','2278P3900X','2278P4000X','2278S1500X','227900000X','2279C0205X','2279E0002X',
						'2279E1000X','2279G0305X','2279G1100X','2279H0200X','2279P1004X','2279P1005X','2279P1006X','2279P3800X','2279P3900X','2279P4000X','2279S1500X','229N00000X','231H00000X','231HA2400X',
						'231HA2500X','235500000X','2355A2700X','2355S0801X','235Z00000X','237600000X','237700000X','242T00000X','243U00000X','246Q00000X','246QB0000X','246QC1000X','246QC2700X','246QH0000X',
						'246QH0401X','246QH0600X','246QI0000X','246QL0900X','246QL0901X','246QM0706X','246QM0900X','246R00000X','246RH0600X','246RM2200X','246RP1900X','246W00000X','246X00000X','246XC2901X',
						'246XC2903X','246XS1301X','246Y00000X','246YC3301X','246YC3302X','246YR1600X','246Z00000X','246ZA2600X','246ZB0301X','246ZB0302X','246ZB0500X','246ZB0600X','246ZC0007X','246ZE0500X',
						'246ZE0600X','246ZG0701X','246ZG1000X','246ZI1000X','246ZN0300X','246ZS0410X','246ZX2200X','247000000X','2470A2800X','247100000X','2471B0102X','2471C1101X','2471C1106X','2471C3401X',
						'2471C3402X','2471M1202X','2471M2300X','2471N0900X','2471Q0001X','2471R0002X','2471S1302X','2471V0105X','2471V0106X','247200000X','2472B0301X','2472D0500X','2472E0500X','2472R0900X',
						'2472V0600X','367H00000X','372500000X','372600000X','373H00000X','374700000X','3747A0650X','3747P1801X','374J00000X','374U00000X','376J00000X','376K00000X','405300000X') then 'OtherProvider'
			else NULL 
			end as IndividualProviderCategories,b.PrimaryInsuranceType
			from /* provide name of table 1 here: */ [NextD].[dbo].[FinalStatTable1] c 
			left join /* provide name of PCORNET table ENCOUNTER here: */ [capricorn].[dbo].[CAP_ENCOUNTERS] a on c.PATID=a.CAP_ID
			left join /* provide name of external source table with raw encounter types and NPI codes here: */ #NEXTD_ENCOUNTERSRemap b on a.[ENCOUNTERID]=b.[ENCOUNTERID]
			left join /* provide name of PCORNET table DEMOGRAPPHIC here: */ capricorn.dbo.DEMOGRAPHIC d on c.PATID=d.PATID
			where (datediff(yy,d.BIRTH_DATE,a.ADMIT_DATE) <= @UpperAge and datediff(yy, d.BIRTH_DATE,a.ADMIT_DATE) >= @LowerAge) 
			and a.ADMIT_DATE >= @LowerTimeFrame and a.ADMIT_DATE <= @UpperTimeFrame
) i ; 
--------------------------------------------------------------------------------------------------------------- 
select a.GLOBALID,i.ENCOUNTERID,i.PROVIDERID, i.ADMIT_DATE_YEAR,i.ADMIT_DATE_MONTH,i.DAYS_from_FirstEncounter_Date,i.ENC_TYPE,i.FACILITYID,i.IndividualProviderCategories,i.PrimaryInsuranceType
into #NextD_ENCOUNTER_FINAL
from #NextD_ENCOUNTER i
join /* provide name the table containing c.PATID,Hashes, and Global patient id*/ #GlobalIDtable d on i.CAP_ID=d.CAP_ID;
 --------------------------------------------------------------------------------------------------------------- 
 /* Save #NextD_ENCOUNTER_FINAL as csv file. 
Use "|" symbol as field terminator and 
"ENDALONAEND" as row terminator. */ 
--------------------------------------------------------------------------------------------------------------- 